/*
  Input parameters:
   - TestFixtureTypeFullName   
   - TestSetUpMethodName
   - TestTearDownMethodName
   - TestFixtureSetUpMethodName
   - TestFixtureTearDownMethodName
   TestCases
		- TestName
		- TestParameters
		- IsAsync
 Output parameters
    - output System.Collections.Generic.List<object> where the object is an anonymous type 
		new {TestName, ErrorMessage, Variables}
*/

//---->START

var output = new System.Collections.Generic.List<object>();
string testFixtureSetUpTearDownError = null;

Type testFixtureType = Type.GetType(TestFixtureTypeFullName);
object testFixture = System.Activator.CreateInstance(testFixtureType);
	    
	
if(TestFixtureSetUpMethodName != null)
{
	// execute TestFixtureSetUp
	try
	{			
			testFixtureType.GetMethod(TestFixtureSetUpMethodName,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, null);
	}
	catch(Exception e)
	{
		testFixtureSetUpTearDownError = e.ToString();
		return;
	}
	finally
	{
		var newCoverage = new
		{
				TestName = TestFixtureSetUpMethodName,
				ErrorMessage = testFixtureSetUpTearDownError,
				Variables = AuditVariablesAutoGenerated941C.Coverage.Values.ToList()
		};

		output.Add(newCoverage);
	}
}

// execute all test cases, one by one.
foreach(var testCase in TestCases)
{
	AuditVariablesAutoGenerated941C.Coverage.Clear();
	string errorMessage=null;

	try
	{
		// execute TestSetUp
		if(TestSetUpMethodName != null)
			testFixtureType.GetMethod(TestSetUpMethodName,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, null);

		// execute test asynchronously or synchronously
		if(testCase.IsAsync)
			((dynamic)testFixtureType.GetMethod(testCase.TestName, BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, testCase.TestParameters)).Wait();
		else
			testFixtureType.GetMethod(testCase.TestName, BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, testCase.TestParameters);

		// execute test tear down
		if(TestTearDownMethodName != null)
			testFixtureType.GetMethod(TestTearDownMethodName,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, null);
	}
	catch(AggregateException e)
	{
		errorMessage=e.InnerException.ToString();
	}
	catch(TargetInvocationException e)
	{
		errorMessage=e.InnerException.ToString();
	}
	catch(Exception e)
	{
		errorMessage=e.ToString();
	}

	var newCoverage = new
	{
		TestName = testCase.TestName,
		ErrorMessage = errorMessage,
		Variables = AuditVariablesAutoGenerated941C.Coverage.Values.ToList()
	};

	output.Add(newCoverage);
}

// execute TestFixtureTearDown
AuditVariablesAutoGenerated941C.Coverage.Clear();

if(TestFixtureTearDownMethodName != null)
{
	try
	{
			testFixtureType.GetMethod(TestFixtureTearDownMethodName,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic).Invoke(testFixture, null);
	}
	catch(Exception e)
	{
		testFixtureSetUpTearDownError = e.ToString();
	}
	finally
	{
		var newCoverage = new
		{
				TestName = TestFixtureTearDownMethodName,
				ErrorMessage = testFixtureSetUpTearDownError,
				Variables = AuditVariablesAutoGenerated941C.Coverage.Values.ToList()
		};

		output.Add(newCoverage);
	}
}